
generator client {
  provider = "prisma-client-js"
  output = "client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PaymentMethodType {
  LIGHTNING
  MERCADOPAGO
}

enum EventStatus {
  DRAFT
  PUBLISHED
}

enum EventRole {
  OWNER
  COLLABORATOR
}

enum OrderStatus {
  PENDING
  PAID
}

model User {
  id             String         @id @default(uuid())
  email          String?        @unique
  nostrPubKey    String?        @unique
  paymentMethods PaymentMethod[]
  eventMembers   EventMember[]
  orders         Order[]
  tickets        Ticket[]

  eventsCreated  Event[]        @relation("CreatedEvents") // âœ… agregado

  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
}

model PaymentMethod {
  id String @id @default(uuid())
  type             PaymentMethodType
  lightningAddress String?
  mpAccessToken    String?
  mpRefreshToken   String?
  mpTokenExpiresAt DateTime?
  mpAccountId      String?
  user             User              @relation(fields: [userId], references: [id])
  userId String
  events           Event[]           @relation("EventPaymentMethods")
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  Order            Order[]

  @@unique([userId, type])
}

model Event {
  id             String          @id @default(uuid())
  title          String
  description    String?
  location       String
  startsAt       DateTime
  endsAt         DateTime
  status         EventStatus     @default(DRAFT)

  creatorId      String
  creator        User            @relation("CreatedEvents", fields: [creatorId], references: [id])

  ticketTypes    TicketType[]
  team           EventMember[]
  paymentMethods PaymentMethod[] @relation("EventPaymentMethods")
  discountCodes  DiscountCode[]
  orders         Order[]
  tickets        Ticket[]

  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model EventMember {
  event     Event     @relation(fields: [eventId], references: [id])
  eventId String
  user      User      @relation(fields: [userId], references: [id])
  userId String
  role      EventRole
  createdAt DateTime  @default(now())

  @@id([eventId, userId])
}

model TicketType {
  id String @id @default(uuid())
  event      Event       @relation(fields: [eventId], references: [id])
  eventId String
  name       String
  price      Float
  quantity   Int
  orderItems OrderItem[]
  tickets    Ticket[]
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  @@unique([eventId, name])
}

model DiscountCode {
  id String @id @default(uuid())
  event      Event     @relation(fields: [eventId], references: [id])
  eventId String
  code       String
  percentage Int
  expiresAt  DateTime?
  maxUses    Int?
  orders     Order[]
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@unique([eventId, code])
}

model Order {
  id String @id @default(uuid())
  event           Event          @relation(fields: [eventId], references: [id])
  eventId String
  buyer           User           @relation(fields: [buyerId], references: [id])
  buyerId String
  status          OrderStatus    @default(PENDING)
  paymentMethod   PaymentMethod? @relation(fields: [paymentMethodId], references: [id])
  paymentMethodId String?
  discountCode    DiscountCode?  @relation(fields: [discountCodeId], references: [id])
  discountCodeId String?
  totalAmount     Float
  items           OrderItem[]
  tickets         Ticket[]
  createdAt       DateTime       @default(now())
  paidAt          DateTime?
  updatedAt       DateTime       @updatedAt
}

model OrderItem {
  order        Order      @relation(fields: [orderId], references: [id])
  orderId String
  ticketType   TicketType @relation(fields: [ticketTypeId], references: [id])
  ticketTypeId String
  quantity     Int
  price        Float
  tickets      Ticket[]

  @@id([orderId, ticketTypeId])
}

model Ticket {
  id String @id @default(uuid())
  event                 Event      @relation(fields: [eventId], references: [id])
  eventId String
  ticketType            TicketType @relation(fields: [ticketTypeId], references: [id])
  ticketTypeId String
  order                 Order      @relation(fields: [orderId], references: [id])
  orderId String
  owner                 User       @relation(fields: [ownerId], references: [id])
  ownerId String
  isCheckedIn           Boolean    @default(false)
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt
  OrderItem             OrderItem? @relation(fields: [orderItemOrderId, orderItemTicketTypeId], references: [orderId, ticketTypeId])
  orderItemOrderId String?
  orderItemTicketTypeId String?
}

model LoginCode {
  id String @id @default(uuid())
  email      String
  code       String
  used       Boolean  @default(false)
  attempts   Int      @default(0)
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  @@index([email, code])
}
